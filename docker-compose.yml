networks:
  steen:
    driver: bridge

volumes:
  mariadb_data:
  caddy_data:
  caddy_config:

services:
  mariadb:
    image: mariadb:11.4.2
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${DB_USER}
      MARIADB_PASSWORD: ${DB_PASSWORD}
    command: ["--character-set-server=utf8mb4", "--collation-server=utf8mb4_unicode_ci"]
    volumes:
      - mariadb_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -uroot -p${DB_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 3s
      retries: 10
    restart: unless-stopped
    networks:
      - steen
    labels:
      - com.centurylinklabs.watchtower.enable=false

  backend:
    image: ghcr.io/lsteen89/steenbudget-backend:latest
    env_file: .env                 # ← JWT_SECRET_KEY, DATABASESETTINGS__CONNECTIONSTRING, WEBSOCKET_SECRET, etc.
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - steen
    pull_policy: always            # ← always pull the latest image
    labels:
      - com.centurylinklabs.watchtower.enable=false

  caddy:
    image: ghcr.io/lsteen89/caddy-cloudflare:2.9.1
    pull_policy: missing                                           # ← don’t pull if already present
    environment:
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN:?set CLOUDFLARE_API_TOKEN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
      - ./frontend/dist:/srv:ro
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks: [steen]
    labels:
      - com.centurylinklabs.watchtower.enable=false   # ← disable watchtower for Caddy

  watchtower:
    image: containrrr/watchtower
    command: --schedule "0 4 * * *" --cleanup --label-enable
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    networks:
      - steen
